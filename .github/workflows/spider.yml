name: SCYS Spider - ServerChan

on:
  schedule:
      # Run at 1:00 and 10:00 UTC (9:00 and 18:00 Beijing time)
          - cron: '0 1 * * *'
              - cron: '0 10 * * *'
                workflow_dispatch: # Allow manual trigger

                jobs:
                  spider:
                      runs-on: ubuntu-latest

                              steps:
                                  - name: Checkout code
                                        uses: actions/checkout@v3

                                                  - name: Setup Python
                                                        uses: actions/setup-python@v4
                                                              with:
                                                                      python-version: '3.9'

                                                                                  - name: Cache Python dependencies
                                                                                        uses: actions/cache@v3
                                                                                              with:
                                                                                                      path: ~/.cache/pip
                                                                                                              key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
                                                                                                                      restore-keys: |
                                                                                                                                ${{ runner.os }}-pip-
                                                                                                                                        
                                                                                                                                            - name: Install dependencies
                                                                                                                                                  run: |
                                                                                                                                                          python -m pip install --upgrade pip
                                                                                                                                                                  pip install -r requirements.txt
                                                                                                                                                                          
                                                                                                                                                                              - name: Create logs directory
                                                                                                                                                                                    run: mkdir -p logs
                                                                                                                                                                                          
                                                                                                                                                                                              - name: Run spider
                                                                                                                                                                                                    env:
                                                                                                                                                                                                            SERVER_CHAN_KEY: ${{ secrets.SERVER_CHAN_KEY }}
                                                                                                                                                                                                                  run: |
                                                                                                                                                                                                                          echo "Starting SCYS spider task..."
                                                                                                                                                                                                                                  echo "Execution time: $(date '+%Y-%m-%d %H:%M:%S')"
                                                                                                                                                                                                                                          echo "Python version: $(python --version)"
                                                                                                                                                                                                                                                  echo "Package info:"
                                                                                                                                                                                                                                                          pip list
                                                                                                                                                                                                                                                                  echo ""
                                                                                                                                                                                                                                                                          echo "Starting spider..."
                                                                                                                                                                                                                                                                                  python spider.py
                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                              - name: Upload log files
                                                                                                                                                                                                                                                                                                    if: always()
                                                                                                                                                                                                                                                                                                          uses: actions/upload-artifact@v3
                                                                                                                                                                                                                                                                                                                with:
                                                                                                                                                                                                                                                                                                                        name: spider-logs-${{ github.run_number }}
                                                                                                                                                                                                                                                                                                                                path: |
                                                                                                                                                                                                                                                                                                                                          *.log
                                                                                                                                                                                                                                                                                                                                                    sent_posts.db
                                                                                                                                                                                                                                                                                                                                                            retention-days: 7
                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                        - name: Check execution results
                                                                                                                                                                                                                                                                                                                                                                              if: always()
                                                                                                                                                                                                                                                                                                                                                                                    run: |
                                                                                                                                                                                                                                                                                                                                                                                            echo "Execution summary:"
                                                                                                                                                                                                                                                                                                                                                                                                    if [ -f spider.log ]; then
                                                                                                                                                                                                                                                                                                                                                                                                              echo "Log file size: $(du -h spider.log | cut -f1)"
                                                                                                                                                                                                                                                                                                                                                                                                                        echo "Log lines: $(wc -l spider.log | cut -d' ' -f1)"
                                                                                                                                                                                                                                                                                                                                                                                                                                  echo ""
                                                                                                                                                                                                                                                                                                                                                                                                                                            echo "Last 10 log lines:"
                                                                                                                                                                                                                                                                                                                                                                                                                                                      tail -10 spider.log
                                                                                                                                                                                                                                                                                                                                                                                                                                                              else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        echo "No log file found"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if [ -f sent_posts.db ]; then
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          echo "Database file size: $(du -h sent_posts.db | cut -f1)"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  else
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            echo "No database file found"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    fi
